<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Todo App - Juris Framework</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .app-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 1.5rem 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.8rem;
            font-weight: 700;
            color: #667eea;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .nav-section {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .nav-link {
            text-decoration: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            transition: all 0.2s ease;
            color: #666;
            font-weight: 500;
        }

        .nav-link:hover {
            background: #f0f0f0;
            color: #333;
        }

        .nav-link.router-link-active {
            background: #667eea;
            color: white;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: #667eea;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
            font-size: 0.9rem;
        }

        .btn:hover {
            background: #5a67d8;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-success {
            background: #28a745;
        }

        .btn-success:hover {
            background: #218838;
        }

        .main-content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            min-height: 400px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .page-content {
            padding: 2rem;
        }

        .page-title {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            color: #333;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .page-subtitle {
            color: #666;
            margin-bottom: 2rem;
        }

        /* Login/Register Forms */
        .auth-container {
            max-width: 400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #555;
        }

        .form-control {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.2s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .error-message {
            background: #fee;
            color: #c53030;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border-left: 4px solid #fc8181;
        }

        .success-message {
            background: #f0fff4;
            color: #22543d;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border-left: 4px solid #48bb78;
        }

        /* Todo App Styles */
        .todo-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .todo-stats {
            display: flex;
            gap: 1rem;
            font-size: 0.9rem;
            color: #666;
        }

        .stat {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .todo-form {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            border: 2px dashed #dee2e6;
        }

        .todo-input-group {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .todo-input {
            flex: 1;
            min-width: 200px;
            padding: 0.75rem;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 1rem;
        }

        .todo-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .priority-select, .category-input {
            padding: 0.75rem;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            background: white;
            min-width: 120px;
        }

        .filters {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-group {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .filter-btn {
            padding: 0.5rem 1rem;
            border: 2px solid #e1e5e9;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.85rem;
        }

        .filter-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .search-input {
            padding: 0.5rem 1rem;
            border: 2px solid #e1e5e9;
            border-radius: 6px;
            min-width: 200px;
        }

        .todo-list {
            space-y: 1rem;
        }

        .todo-item {
            background: white;
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            transition: all 0.2s ease;
            position: relative;
        }

        .todo-item:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .todo-item.completed {
            background: #f8f9fa;
            opacity: 0.7;
        }

        .todo-item.completed .todo-text {
            text-decoration: line-through;
            color: #6c757d;
        }

        .todo-content {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
        }

        .todo-checkbox {
            margin-top: 0.25rem;
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .todo-details {
            flex: 1;
        }

        .todo-text {
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .todo-meta {
            display: flex;
            gap: 1rem;
            font-size: 0.85rem;
            color: #666;
            margin-bottom: 0.5rem;
            flex-wrap: wrap;
        }

        .priority {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-weight: 500;
            font-size: 0.75rem;
        }

        .priority-high {
            background: #fee;
            color: #c53030;
        }

        .priority-medium {
            background: #fffbeb;
            color: #92400e;
        }

        .priority-low {
            background: #f0fff4;
            color: #22543d;
        }

        .category {
            background: #e6fffa;
            color: #234e52;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .todo-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .btn-small {
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
            border-radius: 4px;
        }

        .empty-state {
            text-align: center;
            padding: 3rem 2rem;
            color: #666;
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #666;
        }

        .sync-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            z-index: 1000;
        }

        .sync-status.syncing {
            background: rgba(255, 193, 7, 0.9);
            color: #000;
        }

        .sync-status.synced {
            background: rgba(40, 167, 69, 0.9);
        }

        .sync-status.error {
            background: rgba(220, 53, 69, 0.9);
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }

            .todo-input-group {
                flex-direction: column;
            }

            .filters {
                flex-direction: column;
                align-items: stretch;
            }

            .filter-group {
                justify-content: center;
            }

            .todo-content {
                flex-direction: column;
                gap: 0.5rem;
            }

            .todo-meta {
                justify-content: center;
            }
        }

        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid currentColor;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="app"></div>

    <!-- Load Juris Framework -->
    <script src="juris.js"></script>

    <script>
        console.time('juris_advanced_todo_app');
        // =================================================================
        // HEADLESS COMPONENTS (Background Services)
        // =================================================================

        // Todo Storage Service (Headless Component)
        const TodoStorageService = (props, context) => ({
            onRegistered: async (props, context) => {
                console.log('ðŸ“¦ Todo Storage Service registered');
                
                // Initialize todos from localStorage
                const savedTodos = localStorage.getItem('juris_todos');
                if (savedTodos) {
                    try {
                        const todos = JSON.parse(savedTodos);
                        context.setState('todos.items', todos);
                        console.log('ðŸ“¥ Loaded todos from localStorage:', todos.length);
                    } catch (error) {
                        console.error('Failed to load todos from localStorage:', error);
                    }
                }

                // Subscribe to todo changes and auto-save
                const unsubscribe = context.subscribe('todos.items', (todos) => {
                    if (todos && Array.isArray(todos)) {
                        context.setState('sync.status', 'syncing');
                        
                        setTimeout(() => {
                            try {
                                localStorage.setItem('juris_todos', JSON.stringify(todos));
                                context.setState('sync.status', 'synced');
                                context.setState('sync.lastSync', new Date().toISOString());
                                console.log('ðŸ’¾ Todos auto-saved to localStorage');
                            } catch (error) {
                                context.setState('sync.status', 'error');
                                context.setState('sync.error', error.message);
                                console.error('Failed to save todos:', error);
                            }
                        }, 500);
                    }
                });

                // Cleanup function
                return () => {
                    unsubscribe();
                    console.log('ðŸ§¹ Todo Storage Service cleanup');
                };
            }
        });

        // Auth Service (Headless Component)
        const AuthService = (props, context) => ({
            onRegistered: async (props, context) => {
                console.log('ðŸ” Auth Service registered');
                
                // Check for existing session
                const savedAuth = localStorage.getItem('juris_auth');
                if (savedAuth) {
                    try {
                        const authData = JSON.parse(savedAuth);
                        context.setState('auth.user', authData);
                        context.setState('auth.isAuthenticated', true);
                        console.log('âœ… Session restored:', authData.username);
                    } catch (error) {
                        console.error('Failed to restore session:', error);
                        localStorage.removeItem('juris_auth');
                    }
                }

                // Subscribe to auth changes and persist
                const unsubscribe = context.subscribe('auth.user', (user) => {
                    if (user) {
                        localStorage.setItem('juris_auth', JSON.stringify(user));
                    } else {
                        localStorage.removeItem('juris_auth');
                    }
                });

                return () => {
                    unsubscribe();
                    console.log('ðŸ§¹ Auth Service cleanup');
                };
            }
        });

        // Todo Manager Service (Headless Component)
        const TodoManagerService = (props, context) => ({
            onRegistered: async (props, context) => {
                console.log('ðŸ“‹ Todo Manager Service registered');
                
                // Add helper methods to context
                const todoHelpers = {
                    addTodo: (text, priority = 'medium', category = 'general') => {
                        const todos = context.getState('todos.items', []);
                        const newTodo = {
                            id: Date.now().toString(),
                            text: text.trim(),
                            completed: false,
                            priority,
                            category,
                            createdAt: new Date().toISOString(),
                            updatedAt: new Date().toISOString()
                        };
                        
                        context.setState('todos.items', [...todos, newTodo]);
                        context.setState('todos.lastAction', { type: 'add', todo: newTodo });
                        return newTodo;
                    },

                    toggleTodo: (id) => {
                        const todos = context.getState('todos.items', []);
                        const updatedTodos = todos.map(todo => 
                            todo.id === id 
                                ? { ...todo, completed: !todo.completed, updatedAt: new Date().toISOString() }
                                : todo
                        );
                        context.setState('todos.items', updatedTodos);
                        
                        const toggledTodo = updatedTodos.find(t => t.id === id);
                        context.setState('todos.lastAction', { 
                            type: 'toggle', 
                            todo: toggledTodo,
                            completed: toggledTodo.completed 
                        });
                    },

                    deleteTodo: (id) => {
                        const todos = context.getState('todos.items', []);
                        const todoToDelete = todos.find(t => t.id === id);
                        const updatedTodos = todos.filter(todo => todo.id !== id);
                        
                        context.setState('todos.items', updatedTodos);
                        context.setState('todos.lastAction', { type: 'delete', todo: todoToDelete });
                    },

                    updateTodo: (id, updates) => {
                        const todos = context.getState('todos.items', []);
                        const updatedTodos = todos.map(todo => 
                            todo.id === id 
                                ? { ...todo, ...updates, updatedAt: new Date().toISOString() }
                                : todo
                        );
                        context.setState('todos.items', updatedTodos);
                        
                        const updatedTodo = updatedTodos.find(t => t.id === id);
                        context.setState('todos.lastAction', { type: 'update', todo: updatedTodo });
                    },

                    clearCompleted: () => {
                        const todos = context.getState('todos.items', []);
                        const completed = todos.filter(t => t.completed);
                        const remaining = todos.filter(t => !t.completed);
                        
                        context.setState('todos.items', remaining);
                        context.setState('todos.lastAction', { 
                            type: 'clearCompleted', 
                            count: completed.length 
                        });
                    },

                    getFilteredTodos: (filter, search, category) => {
                        const todos = context.getState('todos.items', []);
                        
                        return todos.filter(todo => {
                            // Filter by completion status
                            if (filter === 'active' && todo.completed) return false;
                            if (filter === 'completed' && !todo.completed) return false;
                            
                            // Filter by search term
                            if (search && !todo.text.toLowerCase().includes(search.toLowerCase())) {
                                return false;
                            }
                            
                            // Filter by category
                            if (category && category !== 'all' && todo.category !== category) {
                                return false;
                            }
                            
                            return true;
                        });
                    },

                    getStats: () => {
                        const todos = context.getState('todos.items', []);
                        return {
                            total: todos.length,
                            completed: todos.filter(t => t.completed).length,
                            active: todos.filter(t => !t.completed).length,
                            high: todos.filter(t => t.priority === 'high').length,
                            medium: todos.filter(t => t.priority === 'medium').length,
                            low: todos.filter(t => t.priority === 'low').length
                        };
                    }
                };

                // Make helpers available globally
                window.todoHelpers = todoHelpers;
                
                return () => {
                    delete window.todoHelpers;
                    console.log('ðŸ§¹ Todo Manager Service cleanup');
                };
            }
        });

        // =================================================================
        // UI COMPONENTS
        // =================================================================

        // Navigation Component
        const Navigation = (props, context) => ({
            render: () => ({
                nav: {
                    className: 'header',
                    children: [
                        {
                            div: {
                                className: 'logo',
                                children: [
                                    { span: { text: 'âœ…' } },
                                    { span: { text: 'TodoMaster' } }
                                ]
                            }
                        },
                        {
                            div: {
                                className: 'nav-section',
                                children: () => {
                                    const isAuthenticated = context.getState('auth.isAuthenticated', false);
                                    const user = context.getState('auth.user', null);

                                    if (isAuthenticated) {
                                        return [
                                            {
                                                RouterLink: {
                                                    to: '/todos',
                                                    className: 'nav-link',
                                                    text: 'ðŸ“‹ My Todos'
                                                }
                                            },
                                            {
                                                span: {
                                                    className: 'nav-link',
                                                    text: `ðŸ‘¤ ${user?.username || 'User'}`
                                                }
                                            },
                                            {
                                                button: {
                                                    className: 'btn btn-secondary',
                                                    text: 'ðŸšª Logout',
                                                    onClick: () => {
                                                        context.setState('auth.user', null);
                                                        context.setState('auth.isAuthenticated', false);
                                                        context.navigate('/login');
                                                    }
                                                }
                                            }
                                        ];
                                    } else {
                                        return [
                                            {
                                                RouterLink: {
                                                    to: '/login',
                                                    className: 'nav-link',
                                                    text: 'ðŸ”‘ Login'
                                                }
                                            },
                                            {
                                                RouterLink: {
                                                    to: '/register',
                                                    className: 'nav-link',
                                                    text: 'ðŸ“ Register'
                                                }
                                            }
                                        ];
                                    }
                                }
                            }
                        }
                    ]
                }
            })
        });

        // Sync Status Component
        const SyncStatus = (props, context) => ({
            render: () => {
                const status = context.getState('sync.status', 'idle');
                const lastSync = context.getState('sync.lastSync', null);
                const error = context.getState('sync.error', null);

                if (status === 'idle') return { div: {} };

                const statusMap = {
                    syncing: { icon: 'â³', text: 'Syncing...', class: 'syncing' },
                    synced: { icon: 'âœ…', text: 'Synced', class: 'synced' },
                    error: { icon: 'âŒ', text: 'Sync Error', class: 'error' }
                };

                const statusInfo = statusMap[status] || statusMap.idle;

                return {
                    div: {
                        className: `sync-status ${statusInfo.class}`,
                        children: [
                            { span: { text: statusInfo.icon } },
                            { span: { text: statusInfo.text } },
                            lastSync && status === 'synced' ? {
                                small: { 
                                    text: ` (${new Date(lastSync).toLocaleTimeString()})`,
                                    style: { opacity: '0.7' }
                                }
                            } : null
                        ].filter(Boolean)
                    }
                };
            }
        });

        // Login Page
        const LoginPage = (props, context) => ({
            render: () => ({
                div: {
                    className: 'page-content',
                    children: [
                        {
                            div: {
                                className: 'auth-container',
                                children: () => {
                                    const isLoading = context.getState('auth.isLoading', false);
                                    const error = context.getState('auth.error', null);

                                    return [
                                        {
                                            h1: {
                                                className: 'page-title',
                                                text: 'ðŸ”‘ Login to TodoMaster'
                                            }
                                        },
                                        {
                                            p: {
                                                className: 'page-subtitle',
                                                text: 'Sign in to manage your todos with cloud sync.'
                                            }
                                        },
                                        error ? {
                                            div: {
                                                className: 'error-message',
                                                text: error
                                            }
                                        } : null,
                                        {
                                            form: {
                                                onSubmit: (e) => {
                                                    e.preventDefault();
                                                    const formData = new FormData(e.target);
                                                    const username = formData.get('username');
                                                    const password = formData.get('password');

                                                    context.setState('auth.isLoading', true);
                                                    context.setState('auth.error', null);

                                                    // Simulate login
                                                    setTimeout(() => {
                                                        if (username && password) {
                                                            const user = {
                                                                id: Date.now(),
                                                                username,
                                                                loginTime: new Date().toISOString()
                                                            };
                                                            
                                                            context.setState('auth.user', user);
                                                            context.setState('auth.isAuthenticated', true);
                                                            context.setState('auth.isLoading', false);
                                                            context.navigate('/todos');
                                                        } else {
                                                            context.setState('auth.error', 'Please enter username and password');
                                                            context.setState('auth.isLoading', false);
                                                        }
                                                    }, 1000);
                                                },
                                                children: [
                                                    {
                                                        div: {
                                                            className: 'form-group',
                                                            children: [
                                                                {
                                                                    label: {
                                                                        text: 'Username:',
                                                                        htmlFor: 'username'
                                                                    }
                                                                },
                                                                {
                                                                    input: {
                                                                        type: 'text',
                                                                        name: 'username',
                                                                        id: 'username',
                                                                        className: 'form-control',
                                                                        placeholder: 'Enter your username',
                                                                        required: true,
                                                                        disabled: isLoading
                                                                    }
                                                                }
                                                            ]
                                                        }
                                                    },
                                                    {
                                                        div: {
                                                            className: 'form-group',
                                                            children: [
                                                                {
                                                                    label: {
                                                                        text: 'Password:',
                                                                        htmlFor: 'password'
                                                                    }
                                                                },
                                                                {
                                                                    input: {
                                                                        type: 'password',
                                                                        name: 'password',
                                                                        id: 'password',
                                                                        className: 'form-control',
                                                                        placeholder: 'Enter your password',
                                                                        required: true,
                                                                        disabled: isLoading
                                                                    }
                                                                }
                                                            ]
                                                        }
                                                    },
                                                    {
                                                        div: {
                                                            children: [
                                                                {
                                                                    button: {
                                                                        type: 'submit',
                                                                        className: 'btn',
                                                                        disabled: isLoading,
                                                                        children: isLoading ? [
                                                                            { span: { className: 'spinner' } },
                                                                            { span: { text: 'Signing in...' } }
                                                                        ] : [
                                                                            { span: { text: 'ðŸ”‘ Sign In' } }
                                                                        ]
                                                                    }
                                                                },
                                                                {
                                                                    RouterLink: {
                                                                        to: '/register',
                                                                        className: 'btn btn-secondary',
                                                                        style: { marginLeft: '1rem' },
                                                                        text: 'ðŸ“ Create Account'
                                                                    }
                                                                }
                                                            ]
                                                        }
                                                    }
                                                ]
                                            }
                                        }
                                    ].filter(Boolean);
                                }
                            }
                        }
                    ]
                }
            })
        });

        // Register Page
        const RegisterPage = (props, context) => ({
            render: () => ({
                div: {
                    className: 'page-content',
                    children: [
                        {
                            div: {
                                className: 'auth-container',
                                children: () => {
                                    const isLoading = context.getState('auth.isLoading', false);
                                    const error = context.getState('auth.error', null);

                                    return [
                                        {
                                            h1: {
                                                className: 'page-title',
                                                text: 'ðŸ“ Join TodoMaster'
                                            }
                                        },
                                        {
                                            p: {
                                                className: 'page-subtitle',
                                                text: 'Create your account to start managing todos.'
                                            }
                                        },
                                        error ? {
                                            div: {
                                                className: 'error-message',
                                                text: error
                                            }
                                        } : null,
                                        {
                                            form: {
                                                onSubmit: (e) => {
                                                    e.preventDefault();
                                                    const formData = new FormData(e.target);
                                                    const username = formData.get('username');
                                                    const email = formData.get('email');
                                                    const password = formData.get('password');

                                                    context.setState('auth.isLoading', true);
                                                    context.setState('auth.error', null);

                                                    // Simulate registration
                                                    setTimeout(() => {
                                                        if (username && email && password) {
                                                            const user = {
                                                                id: Date.now(),
                                                                username,
                                                                email,
                                                                loginTime: new Date().toISOString()
                                                            };
                                                            
                                                            context.setState('auth.user', user);
                                                            context.setState('auth.isAuthenticated', true);
                                                            context.setState('auth.isLoading', false);
                                                            context.navigate('/todos');
                                                        } else {
                                                            context.setState('auth.error', 'Please fill in all fields');
                                                            context.setState('auth.isLoading', false);
                                                        }
                                                    }, 1000);
                                                },
                                                children: [
                                                    {
                                                        div: {
                                                            className: 'form-group',
                                                            children: [
                                                                {
                                                                    label: {
                                                                        text: 'Username:',
                                                                        htmlFor: 'username'
                                                                    }
                                                                },
                                                                {
                                                                    input: {
                                                                        type: 'text',
                                                                        name: 'username',
                                                                        id: 'username',
                                                                        className: 'form-control',
                                                                        placeholder: 'Choose a username',
                                                                        required: true,
                                                                        disabled: isLoading
                                                                    }
                                                                }
                                                            ]
                                                        }
                                                    },
                                                    {
                                                        div: {
                                                            className: 'form-group',
                                                            children: [
                                                                {
                                                                    label: {
                                                                        text: 'Email:',
                                                                        htmlFor: 'email'
                                                                    }
                                                                },
                                                                {
                                                                    input: {
                                                                        type: 'email',
                                                                        name: 'email',
                                                                        id: 'email',
                                                                        className: 'form-control',
                                                                        placeholder: 'Enter your email',
                                                                        required: true,
                                                                        disabled: isLoading
                                                                    }
                                                                }
                                                            ]
                                                        }
                                                    },
                                                    {
                                                        div: {
                                                            className: 'form-group',
                                                            children: [
                                                                {
                                                                    label: {
                                                                        text: 'Password:',
                                                                        htmlFor: 'password'
                                                                    }
                                                                },
                                                                {
                                                                    input: {
                                                                        type: 'password',
                                                                        name: 'password',
                                                                        id: 'password',
                                                                        className: 'form-control',
                                                                        placeholder: 'Create a password',
                                                                        required: true,
                                                                        disabled: isLoading
                                                                    }
                                                                }
                                                            ]
                                                        }
                                                    },
                                                    {
                                                        div: {
                                                            children: [
                                                                {
                                                                    button: {
                                                                        type: 'submit',
                                                                        className: 'btn',
                                                                        disabled: isLoading,
                                                                        children: isLoading ? [
                                                                            { span: { className: 'spinner' } },
                                                                            { span: { text: 'Creating Account...' } }
                                                                        ] : [
                                                                            { span: { text: 'ðŸ“ Create Account' } }
                                                                        ]
                                                                    }
                                                                },
                                                                {
                                                                    RouterLink: {
                                                                        to: '/login',
                                                                        className: 'btn btn-secondary',
                                                                        style: { marginLeft: '1rem' },
                                                                        text: 'ðŸ”‘ Sign In Instead'
                                                                    }
                                                                }
                                                            ]
                                                        }
                                                    }
                                                ]
                                            }
                                        }
                                    ].filter(Boolean);
                                }
                            }
                        }
                    ]
                }
            })
        });

        // Todo App Page
        const TodosPage = (props, context) => ({
            render: () => {
                const todos = context.getState('todos.items', []);
                const filter = context.getState('todos.filter', 'all');
                const search = context.getState('todos.search', '');
                const selectedCategory = context.getState('todos.selectedCategory', 'all');
                
                const filteredTodos = window.todoHelpers?.getFilteredTodos(filter, search, selectedCategory) || [];
                const stats = window.todoHelpers?.getStats() || {};
                const categories = [...new Set(todos.map(t => t.category))];

                return {
                    div: {
                        className: 'page-content',
                        children: [
                            // Header with stats
                            {
                                div: {
                                    className: 'todo-header',
                                    children: [
                                        {
                                            h1: {
                                                className: 'page-title',
                                                text: 'ðŸ“‹ My Todos'
                                            }
                                        },
                                        {
                                            div: {
                                                className: 'todo-stats',
                                                children: [
                                                    {
                                                        div: {
                                                            className: 'stat',
                                                            children: [
                                                                { span: { text: 'ðŸ“' } },
                                                                { span: { text: `${stats.total || 0} Total` } }
                                                            ]
                                                        }
                                                    },
                                                    {
                                                        div: {
                                                            className: 'stat',
                                                            children: [
                                                                { span: { text: 'âœ…' } },
                                                                { span: { text: `${stats.completed || 0} Done` } }
                                                            ]
                                                        }
                                                    },
                                                    {
                                                        div: {
                                                            className: 'stat',
                                                            children: [
                                                                { span: { text: 'â³' } },
                                                                { span: { text: `${stats.active || 0} Active` } }
                                                            ]
                                                        }
                                                    }
                                                ]
                                            }
                                        }
                                    ]
                                }
                            },

                            // Add Todo Form
                            {
                                div: {
                                    className: 'todo-form',
                                    children: [
                                        {
                                            h3: {
                                                text: 'âž• Add New Todo',
                                                style: { marginBottom: '1rem' }
                                            }
                                        },
                                        {
                                            form: {
                                                onSubmit: (e) => {
                                                    e.preventDefault();
                                                    const formData = new FormData(e.target);
                                                    const text = formData.get('text');
                                                    const priority = formData.get('priority');
                                                    const category = formData.get('category');

                                                    if (text.trim() && window.todoHelpers) {
                                                        window.todoHelpers.addTodo(text, priority, category);
                                                        e.target.reset();
                                                    }
                                                },
                                                children: [
                                                    {
                                                        div: {
                                                            className: 'todo-input-group',
                                                            children: [
                                                                {
                                                                    input: {
                                                                        type: 'text',
                                                                        name: 'text',
                                                                        className: 'todo-input',
                                                                        placeholder: 'What needs to be done?',
                                                                        required: true
                                                                    }
                                                                },
                                                                {
                                                                    select: {
                                                                        name: 'priority',
                                                                        className: 'priority-select',
                                                                        children: [
                                                                            { option: { value: 'low', text: 'ðŸŸ¢ Low' } },
                                                                            { option: { value: 'medium', text: 'ðŸŸ¡ Medium', selected: true } },
                                                                            { option: { value: 'high', text: 'ðŸ”´ High' } }
                                                                        ]
                                                                    }
                                                                },
                                                                {
                                                                    input: {
                                                                        type: 'text',
                                                                        name: 'category',
                                                                        className: 'category-input',
                                                                        placeholder: 'Category',
                                                                        value: 'general'
                                                                    }
                                                                },
                                                                {
                                                                    button: {
                                                                        type: 'submit',
                                                                        className: 'btn',
                                                                        text: 'âž• Add Todo'
                                                                    }
                                                                }
                                                            ]
                                                        }
                                                    }
                                                ]
                                            }
                                        }
                                    ]
                                }
                            },

                            // Filters
                            {
                                div: {
                                    className: 'filters',
                                    children: [
                                        {
                                            div: {
                                                className: 'filter-group',
                                                children: [
                                                    { span: { text: 'Show:', style: { fontWeight: '500' } } },
                                                    {
                                                        button: {
                                                            className: () => `filter-btn ${filter === 'all' ? 'active' : ''}`,
                                                            text: 'All',
                                                            onClick: () => context.setState('todos.filter', 'all')
                                                        }
                                                    },
                                                    {
                                                        button: {
                                                            className: () => `filter-btn ${filter === 'active' ? 'active' : ''}`,
                                                            text: 'Active',
                                                            onClick: () => context.setState('todos.filter', 'active')
                                                        }
                                                    },
                                                    {
                                                        button: {
                                                            className: () => `filter-btn ${filter === 'completed' ? 'active' : ''}`,
                                                            text: 'Completed',
                                                            onClick: () => context.setState('todos.filter', 'completed')
                                                        }
                                                    }
                                                ]
                                            }
                                        },
                                        {
                                            div: {
                                                className: 'filter-group',
                                                children: [
                                                    { span: { text: 'Category:', style: { fontWeight: '500' } } },
                                                    {
                                                        select: {
                                                            className: 'priority-select',
                                                            value: () => selectedCategory,
                                                            onChange: (e) => context.setState('todos.selectedCategory', e.target.value),
                                                            children: () => [
                                                                { option: { value: 'all', text: 'All Categories' } },
                                                                ...categories.map(cat => ({
                                                                    option: { value: cat, text: cat }
                                                                }))
                                                            ]
                                                        }
                                                    }
                                                ]
                                            }
                                        },
                                        {
                                            input: {
                                                type: 'text',
                                                className: 'search-input',
                                                placeholder: 'ðŸ” Search todos...',
                                                value: () => search,
                                                onInput: (e) => context.setState('todos.search', e.target.value)
                                            }
                                        },
                                        stats.completed > 0 ? {
                                            button: {
                                                className: 'btn btn-secondary',
                                                text: 'ðŸ—‘ï¸ Clear Completed',
                                                onClick: () => window.todoHelpers?.clearCompleted()
                                            }
                                        } : null
                                    ].filter(Boolean)
                                }
                            },

                            // Todo List
                            {
                                div: {
                                    className: 'todo-list',
                                    children: () => {
                                        if (filteredTodos.length === 0) {
                                            const emptyMessages = {
                                                all: 'No todos yet. Add one above!',
                                                active: 'No active todos. Great job!',
                                                completed: 'No completed todos yet.'
                                            };

                                            return [
                                                {
                                                    div: {
                                                        className: 'empty-state',
                                                        children: [
                                                            {
                                                                div: {
                                                                    className: 'empty-state-icon',
                                                                    text: filter === 'completed' ? 'ðŸŽ‰' : 'ðŸ“'
                                                                }
                                                            },
                                                            {
                                                                p: {
                                                                    text: emptyMessages[filter] || emptyMessages.all
                                                                }
                                                            }
                                                        ]
                                                    }
                                                }
                                            ];
                                        }

                                        return filteredTodos.map(todo => ({
                                            div: {
                                                className: `todo-item ${todo.completed ? 'completed' : ''}`,
                                                children: [
                                                    {
                                                        div: {
                                                            className: 'todo-content',
                                                            children: [
                                                                {
                                                                    input: {
                                                                        type: 'checkbox',
                                                                        className: 'todo-checkbox',
                                                                        checked: todo.completed,
                                                                        onChange: () => window.todoHelpers?.toggleTodo(todo.id)
                                                                    }
                                                                },
                                                                {
                                                                    div: {
                                                                        className: 'todo-details',
                                                                        children: [
                                                                            {
                                                                                div: {
                                                                                    className: 'todo-text',
                                                                                    text: todo.text
                                                                                }
                                                                            },
                                                                            {
                                                                                div: {
                                                                                    className: 'todo-meta',
                                                                                    children: [
                                                                                        {
                                                                                            span: {
                                                                                                className: `priority priority-${todo.priority}`,
                                                                                                text: {
                                                                                                    high: 'ðŸ”´ High',
                                                                                                    medium: 'ðŸŸ¡ Medium',
                                                                                                    low: 'ðŸŸ¢ Low'
                                                                                                }[todo.priority]
                                                                                            }
                                                                                        },
                                                                                        {
                                                                                            span: {
                                                                                                className: 'category',
                                                                                                text: `ðŸ“‚ ${todo.category}`
                                                                                            }
                                                                                        },
                                                                                        {
                                                                                            span: {
                                                                                                text: `ðŸ“… ${new Date(todo.createdAt).toLocaleDateString()}`
                                                                                            }
                                                                                        }
                                                                                    ]
                                                                                }
                                                                            },
                                                                            {
                                                                                div: {
                                                                                    className: 'todo-actions',
                                                                                    children: [
                                                                                        {
                                                                                            button: {
                                                                                                className: 'btn btn-danger btn-small',
                                                                                                text: 'ðŸ—‘ï¸ Delete',
                                                                                                onClick: () => {
                                                                                                    if (confirm('Delete this todo?')) {
                                                                                                        window.todoHelpers?.deleteTodo(todo.id);
                                                                                                    }
                                                                                                }
                                                                                            }
                                                                                        }
                                                                                    ]
                                                                                }
                                                                            }
                                                                        ]
                                                                    }
                                                                }
                                                            ]
                                                        }
                                                    }
                                                ]
                                            }
                                        }));
                                    }
                                }
                            }
                        ]
                    }
                };
            }
        });

        // Homepage
        const HomePage = (props, context) => ({
            render: () => ({
                div: {
                    className: 'page-content',
                    children: [
                        {
                            div: {
                                style: { textAlign: 'center', padding: '3rem 0' },
                                children: [
                                    {
                                        h1: {
                                            className: 'page-title',
                                            text: 'âœ… Welcome to TodoMaster',
                                            style: { fontSize: '3rem', marginBottom: '1rem' }
                                        }
                                    },
                                    {
                                        p: {
                                            className: 'page-subtitle',
                                            text: 'The ultimate todo app with cloud sync, smart filtering, and beautiful design.',
                                            style: { fontSize: '1.2rem', marginBottom: '2rem' }
                                        }
                                    },
                                    {
                                        div: {
                                            children: () => {
                                                const isAuthenticated = context.getState('auth.isAuthenticated', false);
                                                
                                                if (isAuthenticated) {
                                                    return [
                                                        {
                                                            RouterLink: {
                                                                to: '/todos',
                                                                className: 'btn',
                                                                style: { fontSize: '1.1rem', padding: '1rem 2rem' },
                                                                text: 'ðŸ“‹ Go to My Todos'
                                                            }
                                                        }
                                                    ];
                                                } else {
                                                    return [
                                                        {
                                                            RouterLink: {
                                                                to: '/register',
                                                                className: 'btn',
                                                                style: { fontSize: '1.1rem', padding: '1rem 2rem', marginRight: '1rem' },
                                                                text: 'ðŸ“ Get Started'
                                                            }
                                                        },
                                                        {
                                                            RouterLink: {
                                                                to: '/login',
                                                                className: 'btn btn-secondary',
                                                                style: { fontSize: '1.1rem', padding: '1rem 2rem' },
                                                                text: 'ðŸ”‘ Sign In'
                                                            }
                                                        }
                                                    ];
                                                }
                                            }
                                        }
                                    }
                                ]
                            }
                        }
                    ]
                }
            })
        });

        // =================================================================
        // APP INITIALIZATION
        // =================================================================

        // Route Guards
        const authGuard = async (context) => {
            const isAuthenticated = context.getState('auth.isAuthenticated', false);
            if (!isAuthenticated) {
                alert('Please log in to access this page.');
                context.navigate('/login');
                return false;
            }
            return true;
        };

        const guestGuard = async (context) => {
            const isAuthenticated = context.getState('auth.isAuthenticated', false);
            if (isAuthenticated) {
                context.navigate('/todos');
                return false;
            }
            return true;
        };

        // Initialize the Juris app
        const app = new Juris({
            // Initial state
            states: {
                auth: {
                    isAuthenticated: false,
                    user: null,
                    isLoading: false,
                    error: null
                },
                todos: {
                    items: [],
                    filter: 'all',
                    search: '',
                    selectedCategory: 'all',
                    lastAction: null
                },
                sync: {
                    status: 'idle',
                    lastSync: null,
                    error: null
                }
            },

            // Register all components
            components: {
                // Headless Components (Background Services)
                TodoStorageService,
                AuthService,
                TodoManagerService,
                
                // UI Components
                Navigation,
                SyncStatus,
                HomePage,
                LoginPage,
                RegisterPage,
                TodosPage
            },

            // Router configuration
            router: {
                mode: 'hash',
                routes: {
                    '/': {
                        component: 'HomePage',
                        meta: { title: 'TodoMaster - Ultimate Todo App' }
                    },
                    '/login': {
                        component: 'LoginPage',
                        guards: [guestGuard],
                        meta: { title: 'Login - TodoMaster' }
                    },
                    '/register': {
                        component: 'RegisterPage',
                        guards: [guestGuard],
                        meta: { title: 'Register - TodoMaster' }
                    },
                    '/todos': {
                        component: 'TodosPage',
                        guards: [authGuard],
                        meta: { title: 'My Todos - TodoMaster' }
                    }
                },
                guards: { authGuard, guestGuard }
            },

            // Main layout
            layout: {
                div: {
                    className: 'app-container',
                    children: [
                        { Navigation: {} },
                        {
                            div: {
                                className: 'main-content',
                                children: [
                                    { Router: {} }
                                ]
                            }
                        },
                        { SyncStatus: {} }
                    ]
                }
            }
        });

        // Render the application
        app.render();

        // Make app available for debugging
        window.app = app;
        
        console.log('ðŸŽ‰ TodoMaster app loaded!');
        console.log('ðŸ’¡ Access app via window.app for debugging');
        console.log('ðŸ“‹ Headless components handle storage, auth, and todo management');
        console.log('ðŸ”„ Local storage sync is automatic');

        console.timeEnd('juris_advanced_todo_app');
    </script>
</body>
</html>